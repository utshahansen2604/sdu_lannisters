pipeline {
   agent any

   stages {
     stage("Checkout Fleetman"){
         steps {
            checkout([$class: 'GitSCM',
            branches: [[name: 'origin/master']],
            extensions: [[$class: 'WipeWorkspace']],
            userRemoteConfigs: [[url: 'https://github.com/mhristof/fleetman.git']]
            ])
         }
        }
      stage("Docker Build and Push to ECR"){
          steps {
                dir("api-gateway") {
                    
                    sh """
                    docker build . -t fleetman-apigateway
                    eval \$(aws ecr get-login --region ap-south-1 --no-include-email | sed 's|https://||')
                    docker tag fleetman-apigateway 580572941932.dkr.ecr.ap-south-1.amazonaws.com/lannisters_repo_apigateway
                    docker push 580572941932.dkr.ecr.ap-south-1.amazonaws.com/lannisters_repo_apigateway
                    """
                    
                }
        }
      }
   }
   post {
    success {
      echo "Executing App Pipeline"
      build job: 'apigateway_deploy'
    }
  }

}